select
null   as  Key_ID,
null   as  MI_Code,
'xd'||cast(a.TEST_ID as nvarchar2(100))  as  Exam_Report_No,
a.HIS_EXAM_ID as  Exam_Requisition_No,
null   as  EMPI_ID,
case when b.INHOSPITAL_ID is null then b.TREAD_ID else null end as  Visit_No,
case when b.INHOSPITAL_ID is null then null else  b.HIS_PATIENT_ID end as  Inhosp_No,
nvl2(b.INHOSPITAL_ID,(select hisi.card_no from his_sb.fin_ipr_inmaininfo@dblink_his_mirror hisi
            where hisi.inpatient_no = b.his_patient_id)
           ,(select distinct hiso.card_no from his_sb.fin_opr_register@dblink_his_mirror hiso
            where hiso.clinic_code = b.tread_id)) as Visit_Card_No,
a.VISIT_ID  as  Visit_Num,
null   as  MR_No,
cast(b.NAME as nvarchar2(100)) as  Pat_Name,
cast(b.GENDER as nvarchar2(100)) as  Sex_Name,
b.BIRTHDAY  as  Date_Birth,
a.AUDIT_TIME  as  Report_Date,
null   as  Report_Dr_Index_No,
a.AUDIT_DOCT_ID  as  Report_Dr_Code,
a.AUDIT_DOCT_NAME  as  Report_Dr_Name,
a.OPERATE_TIME  as  Exam_Date,
a.DEVICE_NO  as  Exam_Equipment_Code,
a.DEVICE_TYPE  as  Exam_Equipment_Name,
null   as  Exam_Item_Type_Code,
null   as  Exam_Item_Type_Name,
(select min(c.ID) from xd.spirit_his_test_type c where c.test_type_name = a.test_reason)  as  Exam_Item_Code,
a.test_reason  as  Exam_Item_Name,
null   as  Exam_Dept_Index_No,
null   as  Exam_Dept_Code,
null   as  Exam_Dept_Name,
null   as  Exam_Dr_Index_No,
a.OPERATE_DOCT_ID  as  Exam_Dr_Code,
a.OPERATE_DOCT_NAME  as  Exam_Dr_Name,
null   as  Exam_Part_Code,
null   as  Exam_Part_Name,
null   as  Exam_Method_Code,
null   as  Exam_Method_Name,
a.TEST_STATE  as  Exam_Report_Status_Code,
null   as  Exam_Report_Status_Name,
to_clob(a.MEDICATION)  as  Exam_Desc,
to_clob(a.MEDICAL_HISTORY)  as  Exam_Result,
null as FTP_URL,
nvl2(b.INHOSPITAL_ID,b.HIS_PATIENT_ID,b.TREAD_ID) as Encounter_ID
from xd.SPIRIT_TEST a 
left join xd.SPIRIT_PATIENT b on a.patient_id = b.patient_id
